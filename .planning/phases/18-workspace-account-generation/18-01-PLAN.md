---
phase: 18-workspace-account-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - appsscript/CreateUser.js
  - app/api/admin/create-workspace-account/route.js
  - lib/hooks/useAdminData.js
  - lib/workspace-email.js
  - lib/google-sheets.js
autonomous: true

must_haves:
  truths:
    - "Apps Script accepts 'create_workspace_account' action and creates Google Workspace user, adds to group, sends welcome email, and updates CLEAN sheet sac_email"
    - "POST /api/admin/create-workspace-account proxies to Apps Script with proper auth, validation, and cache invalidation"
    - "useCreateWorkspaceAccount hook calls the API route and invalidates members cache on success"
    - "generateEmailCandidates utility produces email candidates from name parts following the same naming strategy as CreateUser.js"
    - "Member API response includes firstName, initial, lastName fields for email candidate generation"
  artifacts:
    - path: "appsscript/CreateUser.js"
      provides: "create_workspace_account action handler in doPost()"
      contains: "case 'create_workspace_account'"
    - path: "app/api/admin/create-workspace-account/route.js"
      provides: "POST endpoint for workspace account creation"
      exports: ["POST"]
    - path: "lib/hooks/useAdminData.js"
      provides: "useCreateWorkspaceAccount mutation hook"
      exports: ["useCreateWorkspaceAccount"]
    - path: "lib/workspace-email.js"
      provides: "Client-side email candidate generator"
      exports: ["generateEmailCandidates", "sanitizeNamePart"]
    - path: "lib/google-sheets.js"
      provides: "firstName, initial, lastName in member objects"
      contains: "firstName"
  key_links:
    - from: "app/api/admin/create-workspace-account/route.js"
      to: "lib/apps-script.js"
      via: "callAppsScript(accessToken, 'create_workspace_account', data)"
      pattern: "callAppsScript.*create_workspace_account"
    - from: "lib/hooks/useAdminData.js"
      to: "/api/admin/create-workspace-account"
      via: "fetch in useCreateWorkspaceAccount mutation"
      pattern: "fetch.*create-workspace-account"
    - from: "appsscript/CreateUser.js"
      to: "createUserAccount + addUserToGroup + sendWelcomeEmail"
      via: "handleCreateWorkspaceAccountAction dispatches to existing functions"
      pattern: "createUserAccount|addUserToGroup|sendWelcomeEmail"
---

<objective>
Create the backend infrastructure for workspace account generation: Apps Script action handler, Next.js API proxy route, TanStack Query mutation hook, client-side email candidate generator, and expose member name parts in API response.

Purpose: Enables the UI layer (Plan 02) to trigger workspace account creation with all data and API endpoints ready.
Output: Working API chain from client hook -> Next.js route -> Apps Script -> Google Workspace, plus email candidate utility for the modal.
</objective>

<execution_context>
@C:/Users/abdie/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/abdie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-apps-script-web-app/15-02-SUMMARY.md
@.planning/phases/16-dashboard-trigger-ui/16-02-SUMMARY.md

Key source files to reference:
@appsscript/CreateUser.js (doPost, createUserAccount, generateEmailCandidates, sanitizeNamePartForEmail, addUserToGroup, sendWelcomeEmail)
@app/api/admin/manual-payment/route.js (API route pattern)
@lib/apps-script.js (callAppsScript utility)
@lib/hooks/useAdminData.js (useManualPayment hook pattern)
@lib/google-sheets.js (getMembers - member object structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apps Script action handler + API proxy route</name>
  <files>appsscript/CreateUser.js, app/api/admin/create-workspace-account/route.js</files>
  <action>
**Apps Script (appsscript/CreateUser.js):**

Add a new case to the `doPost()` switch statement (around line 1234):

```javascript
case 'create_workspace_account':
  return handleCreateWorkspaceAccountAction(payload.data)
```

Create `handleCreateWorkspaceAccountAction(data)` function that:
1. Validates required fields: `email` (personal email), `firstName`, `lastName`, `sacEmail` (the selected workspace email). Optional: `initial`, `slastName`, `phone`.
2. Acquires a script lock with `tryLock(10000)` (same as manual_payment pattern) — return `{ success: false, error: 'OPERATION_IN_PROGRESS' }` if lock not acquired.
3. Calls `setupServices({})` to initialize workspace directory and other services.
4. Calls `generatePassword()` to create password data.
5. Calls `createWorkspaceUser(userData, data.sacEmail, passwordData)` where userData is built from the data fields. Note: we pass `data.sacEmail` directly (the admin selected this email from candidates, so we skip the createEmail availability check — the frontend already presents candidates but the actual availability check happens server-side in createEmail; for this flow we trust the admin's selection but we should still use the passed sacEmail directly).
6. If user creation fails, return `{ success: false, error: 'Error al crear usuario de Workspace' }`.
7. Build accountResult object: `{ success: true, email: data.sacEmail, password: passwordData.plainPassword, userData }`.
8. Call `addUserToGroup(accountResult)` — log but don't fail if group add fails.
9. Call `sendWelcomeEmail(accountResult)` — log but don't fail if welcome email fails.
10. Send credentials email to personal email (same pattern as lines 2198-2221 in existing code): subject "Tu cuenta SAC / Your SAC account", body with sacEmail + plain password + instructions.
11. Find member in CLEAN sheet by personal email (same lookup pattern as existing code around line 2056-2079: get cleanHeaders, find E-mail column index, iterate rows to find match).
12. If found, update `sac_email` column (same pattern as lines 2243-2251) and `created_at` column.
13. Return `{ success: true, sacEmail: data.sacEmail, message: 'Cuenta creada exitosamente' }`.
14. Release lock in `finally` block.

**IMPORTANT:** The function must call `setupServices({})` before using `workspaceDirectory` or `gmailApp` globals. The existing flow calls this in handleScanAction before handleNewMemberships which then calls createUserAccount. In this new action, we need to call it explicitly.

**API Route (app/api/admin/create-workspace-account/route.js):**

Create following the manual-payment route pattern:
1. Import `auth` from `../../../../auth`, `NextResponse`, `callAppsScript` from `../../../../lib/apps-script`, `invalidateCache` from `../../../../lib/cache`.
2. Export `POST = auth(async function POST(req) { ... })`.
3. Auth check: return 401 if `!req.auth` (Spanish: "No autenticado"). Return 401 if `!req.auth.accessToken` (Spanish: "Sesion expirada").
4. Parse request body. Validate required fields: `email`, `firstName`, `lastName`, `sacEmail`. Return 400 if missing (Spanish: "Campos requeridos faltantes", details: "Required: email, firstName, lastName, sacEmail").
5. Validate `sacEmail` ends with `@sociedadastronomia.com`. Return 400 if not (Spanish: "Email SAC no valido").
6. Call `callAppsScript(accessToken, 'create_workspace_account', { email, firstName, initial, lastName, slastName, sacEmail, phone })`.
7. If `!result.success`: map `OPERATION_IN_PROGRESS` to 409, else 500. Return error.
8. Call `invalidateCache()` after success.
9. Return `NextResponse.json(result)`.
10. Catch block: map AbortError to 504 (Spanish: "Tiempo de espera agotado"), else 500 (Spanish: "Error al crear cuenta de Workspace").
  </action>
  <verify>
1. Check that `appsscript/CreateUser.js` contains `case 'create_workspace_account'` in doPost()
2. Check that `handleCreateWorkspaceAccountAction` function exists and calls `createWorkspaceUser`, `addUserToGroup`, `sendWelcomeEmail`
3. Check that `app/api/admin/create-workspace-account/route.js` exists and exports POST
4. Run `npx next build` (expect compilation success for the new route — pre-existing prettier errors in other files are known)
  </verify>
  <done>
Apps Script doPost() handles 'create_workspace_account' action by creating the workspace user, adding to group, sending welcome email, updating CLEAN sheet sac_email, and returning success/error. API route validates inputs, proxies to Apps Script, and invalidates cache on success.
  </done>
</task>

<task type="auto">
  <name>Task 2: Email candidate utility + mutation hook + member name parts</name>
  <files>lib/workspace-email.js, lib/hooks/useAdminData.js, lib/google-sheets.js</files>
  <action>
**Client-side email candidate generator (lib/workspace-email.js):**

Create a new file that ports the email generation logic from CreateUser.js for client-side use. This is a pure utility with no server dependencies.

```javascript
// lib/workspace-email.js

const SAC_DOMAIN = '@sociedadastronomia.com'

/**
 * Sanitize a name part for use in email address.
 * Removes diacritics (a -> a, n -> n), strips non a-z, lowercases.
 * Mirrors appsscript/CreateUser.js sanitizeNamePartForEmail().
 */
export function sanitizeNamePart(text) {
  if (!text) return ''
  const lower = String(text).trim().toLowerCase()
  const noDiacritics = lower.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
  return noDiacritics.replace(/[^a-z]/g, '')
}

/**
 * Generate workspace email candidates from member name parts.
 * Returns array of full email addresses in priority order.
 * Mirrors appsscript/CreateUser.js generateEmailCandidates().
 *
 * @param {{ firstName: string, initial?: string, lastName: string, slastName?: string }} parts
 * @returns {string[]} Email candidates, e.g. ['juan.rivera@sociedadastronomia.com', ...]
 */
export function generateEmailCandidates({ firstName, initial, lastName, slastName }) {
  const fn = sanitizeNamePart(firstName)
  const ini = sanitizeNamePart(initial).charAt(0)
  const ln = sanitizeNamePart(lastName)
  const sln = sanitizeNamePart(slastName)

  const usernames = []
  if (fn && ln) usernames.push(`${fn}.${ln}`)
  if (fn && ln && sln) usernames.push(`${fn}.${ln}.${sln}`)
  if (fn && ini && ln) usernames.push(`${fn}.${ini}.${ln}`)
  if (fn && ini && ln && sln) usernames.push(`${fn}.${ini}.${ln}.${sln}`)

  return usernames.map((u) => `${u}${SAC_DOMAIN}`)
}
```

**Mutation hook (lib/hooks/useAdminData.js):**

Add `useCreateWorkspaceAccount` export, following the `useManualPayment` pattern exactly:

```javascript
/**
 * Mutation hook for creating a workspace account
 * Calls POST /api/admin/create-workspace-account
 *
 * On success, invalidates members cache to refresh dashboard (member's sacEmail changes)
 *
 * Usage:
 *   const { mutate, isPending, error, reset } = useCreateWorkspaceAccount()
 *   mutate({ email, firstName, initial, lastName, slastName, sacEmail, phone })
 *
 * @returns {import('@tanstack/react-query').UseMutationResult}
 */
export function useCreateWorkspaceAccount() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ email, firstName, initial, lastName, slastName, sacEmail, phone }) => {
      const res = await fetch('/api/admin/create-workspace-account', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, firstName, initial, lastName, slastName, sacEmail, phone }),
      })

      handleAuthError(res)

      if (!res.ok) {
        const error = await res.json().catch(() => ({ error: 'Unknown error' }))
        throw new Error(error.details || error.error || 'Error al crear cuenta de Workspace')
      }

      return res.json()
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['members'] })
    },
  })
}
```

**Member name parts (lib/google-sheets.js):**

In the `getMembers()` function's `rows.map()` callback (around line 270-274), the code already extracts `firstName` and `lastName` but only exposes the joined `name`. Additionally, `initial` (Inicial column) is not read at all.

Add reading of the `Inicial` column and expose individual name parts in the returned member object:

1. After the existing `lastName` extraction (line 273), add:
   ```javascript
   const initial = row.get('Inicial') || row.get('Initial') || row.get('initial') || ''
   ```

2. In the existing `fullLastName` handling (the lastName from the sheet contains both apellidos joined), we need to split it. The CLEAN sheet's "Apellidos" column contains the full last name (e.g., "Rivera Cruz"). The Apps Script splits this with `fullLastName.split(/[\s-]/)` into lastName and slastName. Do the same:
   ```javascript
   const lastNameParts = lastName.split(/[\s-]/)
   const apellido1 = lastNameParts[0] || ''
   const apellido2 = lastNameParts.slice(1).join(' ') || ''
   ```

3. In the return object (around line 298-310), add these fields:
   ```javascript
   firstName: firstName.trim() || null,
   initial: initial.trim() || null,
   lastName: apellido1.trim() || null,
   slastName: apellido2.trim() || null,
   ```

**IMPORTANT:** Do NOT remove the existing `name` field — it's used throughout the UI. The new fields are additions.
  </action>
  <verify>
1. Check that `lib/workspace-email.js` exports `generateEmailCandidates` and `sanitizeNamePart`
2. Check that `lib/hooks/useAdminData.js` exports `useCreateWorkspaceAccount`
3. Check that `lib/google-sheets.js` member objects now include `firstName`, `initial`, `lastName`, `slastName` fields
4. Run `npx next build` (expect compilation success — pre-existing prettier errors in other files are known)
  </verify>
  <done>
Client-side email candidate generator mirrors Apps Script logic. useCreateWorkspaceAccount hook calls the API route and invalidates members cache. Member objects include firstName, initial, lastName, slastName for the modal to generate email candidates.
  </done>
</task>

</tasks>

<verification>
1. Apps Script doPost() switch contains 'create_workspace_account' case
2. handleCreateWorkspaceAccountAction function creates workspace user, adds to group, sends emails, updates CLEAN sheet
3. POST /api/admin/create-workspace-account route exists with auth, validation, Apps Script proxy, cache invalidation
4. useCreateWorkspaceAccount hook exported from useAdminData.js
5. generateEmailCandidates and sanitizeNamePart exported from lib/workspace-email.js
6. Member API response includes firstName, initial, lastName, slastName fields
7. Build compiles successfully (new files only)
</verification>

<success_criteria>
- The API chain (hook -> route -> Apps Script -> Google Workspace) is fully wired
- Email candidate generation logic matches the Apps Script naming strategy (sanitize diacritics, firstname.lastname, firstname.lastname.slastname, firstname.initial.lastname, firstname.initial.lastname.slastname)
- Member objects expose name parts needed for client-side email candidate generation
- All new files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-workspace-account-generation/18-01-SUMMARY.md`
</output>
