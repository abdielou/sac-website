---
phase: 18-workspace-account-generation
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - components/admin/MemberActions.js
  - components/admin/WorkspaceAccountModal.js
  - app/admin/members/page.js
autonomous: true

must_haves:
  truths:
    - "Kebab menu for a member WITHOUT sacEmail shows 'Generar Cuenta Workspace' option"
    - "Kebab menu for a member WITH sacEmail does NOT show the workspace option"
    - "Modal displays email candidates derived from member's firstName, initial, lastName, slastName"
    - "Admin can select an email candidate from a disabled-by-default select field, then enable it and trigger account creation"
    - "After successful creation, the modal closes and the members list refreshes showing the new sacEmail"
  artifacts:
    - path: "components/admin/WorkspaceAccountModal.js"
      provides: "Modal for workspace account creation with email candidate select"
      min_lines: 80
    - path: "components/admin/MemberActions.js"
      provides: "WORKSPACE option in kebab menu (conditional on !sacEmail)"
      contains: "WORKSPACE"
    - path: "app/admin/members/page.js"
      provides: "Integration of WorkspaceAccountModal with WORKSPACE action handling"
      contains: "WorkspaceAccountModal"
  key_links:
    - from: "components/admin/MemberActions.js"
      to: "app/admin/members/page.js"
      via: "onAction(member, 'WORKSPACE') callback"
      pattern: "WORKSPACE"
    - from: "components/admin/WorkspaceAccountModal.js"
      to: "lib/hooks/useAdminData.js"
      via: "useCreateWorkspaceAccount() hook"
      pattern: "useCreateWorkspaceAccount"
    - from: "components/admin/WorkspaceAccountModal.js"
      to: "lib/workspace-email.js"
      via: "generateEmailCandidates() for candidate list"
      pattern: "generateEmailCandidates"
    - from: "app/admin/members/page.js"
      to: "components/admin/WorkspaceAccountModal.js"
      via: "Renders WorkspaceAccountModal with member + isOpen props"
      pattern: "WorkspaceAccountModal"
---

<objective>
Build the UI layer for workspace account generation: extend MemberActions with conditional WORKSPACE option, create WorkspaceAccountModal with email candidate selection, and wire into the members page.

Purpose: Completes the full feature — admins can generate workspace accounts directly from the member list.
Output: Working end-to-end flow from kebab menu click to workspace account creation.
</objective>

<execution_context>
@C:/Users/abdie/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/abdie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-workspace-account-generation/18-01-SUMMARY.md

Key source files to reference:
@components/admin/MemberActions.js (existing kebab menu)
@components/admin/ManualPaymentModal.js (modal pattern to follow)
@lib/workspace-email.js (generateEmailCandidates from Plan 01)
@lib/hooks/useAdminData.js (useCreateWorkspaceAccount from Plan 01)
@app/admin/members/page.js (members page integration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: WorkspaceAccountModal + MemberActions WORKSPACE option</name>
  <files>components/admin/WorkspaceAccountModal.js, components/admin/MemberActions.js</files>
  <action>
**MemberActions.js — Add conditional WORKSPACE option:**

Update the JSDoc `@param` to include `'WORKSPACE'` in the paymentType union:
```javascript
@param {{ member: { email: string, phone?: string, name?: string, sacEmail?: string }, onAction: (member, paymentType: 'GIFT'|'MANUAL'|'WORKSPACE') => void }} props
```

Add a third button in the dropdown, but ONLY if the member does NOT have a sacEmail. Insert before or after the existing two buttons (after "Registrar pago de membresia" is a good spot):

```jsx
{!member.sacEmail && (
  <button
    type="button"
    onClick={() => handleSelect('WORKSPACE')}
    className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center gap-2"
  >
    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
    </svg>
    Generar Cuenta Workspace
  </button>
)}
```

The SVG icon is an @ symbol (email/account icon). This ensures WKSP-01 (visible only without sacEmail) and the inverse for WKSP-02 (hidden when sacEmail exists).

**WorkspaceAccountModal.js — Create new modal component:**

Create `components/admin/WorkspaceAccountModal.js` following the ManualPaymentModal pattern exactly (portal, backdrop, header, form, footer):

```javascript
'use client'

import { useState, useEffect } from 'react'
import { createPortal } from 'react-dom'
import { useCreateWorkspaceAccount } from '@/lib/hooks/useAdminData'
import { generateEmailCandidates } from '@/lib/workspace-email'
```

**Props:** `{ isOpen, onClose, member }`
- No `paymentType` prop needed (this modal is workspace-only)

**State:**
- `selectedEmail` (string, default '') — the chosen email candidate
- `isSelectEnabled` (boolean, default false) — select is disabled by default per WKSP-03
- `candidates` (array of strings) — generated from member name parts

**useEffect on `isOpen` + `member`:**
When modal opens with a member:
1. Reset `selectedEmail` to ''
2. Reset `isSelectEnabled` to false
3. Generate candidates: call `generateEmailCandidates({ firstName: member.firstName, initial: member.initial, lastName: member.lastName, slastName: member.slastName })`.
4. Store candidates in state. If no candidates generated (e.g., member name is empty), set candidates to empty array.
5. Call `resetMutation()` to clear any previous errors.

**Form layout:**

1. **Member info display** (read-only, same gray box as ManualPaymentModal):
   - Show member name (member.name) and personal email (member.email)

2. **Email candidates section:**
   - Label: "Email Workspace"
   - A checkbox/toggle to enable the select: "Confirmar seleccion" with a checkbox input. When checked, `isSelectEnabled` becomes true.
   - A `<select>` element showing candidates, DISABLED when `!isSelectEnabled` (per WKSP-03).
   - Default option: "-- Seleccionar email --" with value ""
   - Each candidate as an `<option>`.
   - When no candidates: show a warning message "No se pudieron generar candidatos. Verifique el nombre del miembro."

3. **No other form fields needed** — the workspace creation uses the member's existing data.

**Submit handler:**
- Prevent default
- Call `mutate({ email: member.email, firstName: member.firstName, initial: member.initial || '', lastName: member.lastName, slastName: member.slastName || '', sacEmail: selectedEmail, phone: member.phone || '' })`
- On success: call `onClose()`

**Submit button:**
- Text: "Crear Cuenta" (while pending: "Creando...")
- Disabled when: `isPending || !selectedEmail || !isSelectEnabled`
- Same styling as ManualPaymentModal submit button (blue, spinner when pending)

**Error display:** Same red text pattern as ManualPaymentModal.

**Footer:** Cancel + Submit buttons (same layout as ManualPaymentModal).

**Use the same CSS classes** (`inputClasses`, `labelClasses`) defined locally or imported. Use the same modal structure (fixed inset-0, bg-black/50, centered card, header with close button, body, footer with border-t).

Export both named and default: `export function WorkspaceAccountModal` and `export default WorkspaceAccountModal`.
  </action>
  <verify>
1. Check that `components/admin/MemberActions.js` contains the WORKSPACE button wrapped in `{!member.sacEmail && (...)}`
2. Check that `components/admin/WorkspaceAccountModal.js` exists with createPortal, useCreateWorkspaceAccount, generateEmailCandidates imports
3. Check that the select element has a disabled state controlled by `isSelectEnabled`
4. Run `npx next build` (expect compilation success for new/modified files)
  </verify>
  <done>
MemberActions shows "Generar Cuenta Workspace" only for members without sacEmail. WorkspaceAccountModal displays email candidates in a disabled-by-default select, enables on checkbox toggle, and triggers account creation via the mutation hook.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire WorkspaceAccountModal into members page</name>
  <files>app/admin/members/page.js</files>
  <action>
**Members page integration (app/admin/members/page.js):**

1. **Import WorkspaceAccountModal:**
   Add import at the top of the file:
   ```javascript
   import { WorkspaceAccountModal } from '@/components/admin/WorkspaceAccountModal'
   ```

2. **Add workspace modal state:**
   Add a second modal state alongside the existing `modalState`:
   ```javascript
   const [workspaceModalState, setWorkspaceModalState] = useState({ isOpen: false, member: null })
   ```

3. **Update handleAction:**
   Modify the existing `handleAction` function to route WORKSPACE actions to the workspace modal:
   ```javascript
   const handleAction = (member, paymentType) => {
     if (paymentType === 'WORKSPACE') {
       setWorkspaceModalState({ isOpen: true, member })
     } else {
       setModalState({ isOpen: true, member, paymentType })
     }
   }
   ```

4. **Add handleCloseWorkspaceModal:**
   ```javascript
   const handleCloseWorkspaceModal = () => {
     setWorkspaceModalState({ isOpen: false, member: null })
   }
   ```

5. **Render WorkspaceAccountModal:**
   Add the modal right after the existing ManualPaymentModal at the end of the MembersContent return:
   ```jsx
   <WorkspaceAccountModal
     isOpen={workspaceModalState.isOpen}
     onClose={handleCloseWorkspaceModal}
     member={workspaceModalState.member}
   />
   ```

No other changes needed to the members page — the MemberActions component already passes the full member object (which now includes firstName, initial, lastName, slastName from Plan 01's google-sheets.js changes).
  </action>
  <verify>
1. Check that `app/admin/members/page.js` imports `WorkspaceAccountModal`
2. Check that `handleAction` routes 'WORKSPACE' to the workspace modal state
3. Check that `WorkspaceAccountModal` is rendered in the JSX
4. Run `npx next build` (expect compilation success)
  </verify>
  <done>
Members page routes WORKSPACE actions to the WorkspaceAccountModal. The full flow works: kebab menu click -> handleAction('WORKSPACE') -> workspace modal opens -> admin selects email -> creates account -> modal closes -> members list refreshes with new sacEmail.
  </done>
</task>

</tasks>

<verification>
1. Kebab menu for members WITHOUT sacEmail shows "Generar Cuenta Workspace" option
2. Kebab menu for members WITH sacEmail does NOT show the workspace option
3. WorkspaceAccountModal opens when "Generar Cuenta Workspace" is clicked
4. Modal displays email candidates generated from member name
5. Select field is disabled by default, enabled by checkbox toggle
6. Submit button is disabled until an email is selected AND the select is enabled
7. On submit, the mutation calls the API route which triggers Apps Script
8. After successful creation, modal closes and members list refreshes
9. All files compile without errors
</verification>

<success_criteria>
- End-to-end flow: kebab menu -> modal -> email select -> create account -> cache refresh -> updated member row
- WKSP-01: Workspace option visible only for members without sacEmail
- WKSP-02: Workspace option hidden for members with sacEmail
- WKSP-03: Select field disabled by default, requires explicit enable
- All 5 phase success criteria are met
</success_criteria>

<output>
After completion, create `.planning/phases/18-workspace-account-generation/18-02-SUMMARY.md`
</output>
