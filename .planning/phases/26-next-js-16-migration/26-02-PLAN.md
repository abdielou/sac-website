---
phase: 26-next-js-16-migration
plan: 02
type: execute
wave: 2
depends_on:
  - 26-01
files_modified:
  - proxy.js
  - middleware.js
autonomous: true
requirements:
  - MIG-02
  - MIG-03
must_haves:
  truths:
    - "proxy.js protects /admin/* routes identically to how middleware.js did"
    - "Unauthenticated requests to /admin are redirected to /auth/signin"
    - "Unauthenticated requests to /api/admin/* return 401 JSON"
    - "Authenticated users on /auth/* are redirected to /admin"
    - "No runtime errors from synchronous params/cookies/headers usage"
  artifacts:
    - path: "proxy.js"
      provides: "Auth.js v5 proxy with route protection"
      contains: "export { proxy }"
  key_links:
    - from: "proxy.js"
      to: "auth.js"
      via: "auth() wrapper import"
      pattern: "import.*auth.*from.*./auth"
    - from: "proxy.js"
      to: "next/server"
      via: "NextResponse for redirects and JSON responses"
      pattern: "NextResponse"
---

<objective>
Rename middleware.js to proxy.js with correct Auth.js v5 export pattern, then verify all admin routes and async APIs work correctly.

Purpose: Complete the mandatory Next.js 16 file convention change and confirm zero regressions across all route types.
Output: Working proxy.js replacing middleware.js, all routes verified functional.
</objective>

<execution_context>
@C:/Users/abdie/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/abdie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-next-js-16-migration/26-RESEARCH.md
@.planning/phases/26-next-js-16-migration/26-01-SUMMARY.md
@middleware.js
@auth.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename middleware.js to proxy.js with Auth.js export</name>
  <files>proxy.js, middleware.js</files>
  <action>
1. Create `proxy.js` in project root with the following content (adapted from current middleware.js):

```js
import { auth } from './auth'
import { NextResponse } from 'next/server'

const proxy = auth((req) => {
  const isLoggedIn = !!req.auth
  const { pathname } = req.nextUrl

  const isAdminApiRoute = pathname.startsWith('/api/admin')
  const isAdminRoute = pathname.startsWith('/admin')
  const isAuthRoute = pathname.startsWith('/auth')
  const isApiAuthRoute = pathname.startsWith('/api/auth')

  // Always allow API auth routes (OAuth callbacks, etc.)
  if (isApiAuthRoute) {
    return NextResponse.next()
  }

  // Admin API routes: return 401 JSON (not redirect)
  if (isAdminApiRoute && !isLoggedIn) {
    return NextResponse.json(
      { error: 'No autenticado', details: 'Authentication required' },
      { status: 401 }
    )
  }

  // Admin page routes: redirect to sign-in
  if (isAdminRoute && !isLoggedIn) {
    const signInUrl = new URL('/auth/signin', req.url)
    signInUrl.searchParams.set('callbackUrl', pathname)
    return NextResponse.redirect(signInUrl)
  }

  // Redirect authenticated users from /auth pages to /admin
  if (isAuthRoute && isLoggedIn) {
    return NextResponse.redirect(new URL('/admin', req.url))
  }

  return NextResponse.next()
})

export { proxy }

export const config = {
  matcher: ['/admin', '/admin/:path*', '/api/admin/:path*', '/auth/:path*', '/api/auth/:path*'],
}
```

2. Delete `middleware.js` using `git rm middleware.js`.

3. The logic is IDENTICAL to the old middleware. The only changes are:
   - `export default auth(...)` becomes `const proxy = auth(...); export { proxy }`
   - File renamed from middleware.js to proxy.js

4. Run `npm run build` to confirm the proxy is recognized by Next.js 16.
  </action>
  <verify>
- `proxy.js` exists in project root
- `middleware.js` does NOT exist
- `npm run build` succeeds
  </verify>
  <done>proxy.js created with identical auth logic, middleware.js deleted, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Verify all route types and async APIs work</name>
  <files></files>
  <action>
1. Start the dev server with `npm run dev` and verify:
   - `/admin` redirects to `/auth/signin` when not logged in (proxy working for page routes)
   - `/api/admin/members` returns 401 JSON when not logged in (proxy working for API routes)
   - `/` loads the homepage (public routes unaffected)
   - A blog post page loads (e.g., `/blog/page/1` -- tests app router with params)
   - Gallery page loads (tests pages/ router hybrid compatibility)

2. For async API verification (MIG-03), the research audit confirmed all files already use `await params` and `await searchParams`. Verify by:
   - Checking the build output has no "Synchronous access to params" warnings
   - Loading a dynamic route like `/blog/page/1` which uses `await params`
   - Loading `/tags/astronomia` (or any tag) which uses `await params`

3. Run `npm run test` to confirm existing tests still pass.

4. Stop the dev server after verification.

Note: This verification is done via dev server and build output inspection. The auth flow itself (login/logout) requires valid OAuth credentials which are environment-specific -- the proxy route matching and redirect logic is verified by confirming the correct HTTP behavior for unauthenticated requests.
  </action>
  <verify>
- Dev server starts without errors
- `/admin` returns 307 redirect to `/auth/signin`
- `/api/admin/members` returns 401
- Build output has no "Synchronous access" warnings
- `npm run test` passes
  </verify>
  <done>All admin routes protected by proxy.js, public routes work, async APIs verified, tests pass, no runtime errors</done>
</task>

</tasks>

<verification>
1. `proxy.js` exists and contains `export { proxy }`
2. `middleware.js` does NOT exist
3. `npm run build` succeeds
4. Dev server: `/admin` redirects unauthenticated users to `/auth/signin`
5. Dev server: `/api/admin/members` returns 401 JSON for unauthenticated requests
6. No "Synchronous access" warnings in build or dev output
7. `npm run test` passes
</verification>

<success_criteria>
proxy.js protects admin routes identically to the old middleware.js, all page types (app router, pages router, dynamic routes) work without errors, and no synchronous API access warnings exist.
</success_criteria>

<output>
After completion, create `.planning/phases/26-next-js-16-migration/26-02-SUMMARY.md`
</output>
