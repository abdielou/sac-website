---
phase: 21-content-migration
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified: []
autonomous: false
user_setup:
  - service: AWS S3
    why: "Image bucket for public blog images"
    env_vars:
      - name: S3_IMAGES_BUCKET_NAME
        source: "AWS Console -> S3 -> Create bucket (public read)"
      - name: S3_ARTICLES_BUCKET_NAME
        source: "AWS Console -> S3 -> Existing articles bucket"
    dashboard_config:
      - task: "Create S3 images bucket with public read access"
        location: "AWS Console -> S3 -> Create bucket -> Set permissions"

must_haves:
  truths:
    - "All 77 blog posts exist as articles/{slug}.json in S3 articles bucket"
    - "All 215 blog images exist in S3 images bucket under images/blog/ path"
    - "Image references in article JSON files point to S3 URLs (not local static paths)"
    - "articles/index.json in S3 contains all migrated posts sorted by date descending"
    - "Public blog renders migrated posts correctly at /blog/YYYY/MM/DD/slug"
    - "npm run build completes without errors"
    - "Original MDX files and blog images are preserved in a backup git branch"
  artifacts:
    - path: "articles/index.json (in S3)"
      provides: "Complete article index with all migrated posts"
    - path: "migration-log.json"
      provides: "Full migration log with post details and spot-check list"
  key_links:
    - from: "articles/{slug}.json (in S3)"
      to: "app/blog/[...slug]/page.js"
      via: "getArticle(slug) reads from S3"
      pattern: "getArticle"
    - from: "images in S3"
      to: "article content"
      via: "S3 URLs in image src attributes"
      pattern: "s3\\.amazonaws\\.com/images/blog"
---

<objective>
Execute the migration script in live mode, verify all four verification methods pass, and archive original files to a backup git branch.

Purpose: This plan takes the migration script built in 21-01 and runs it against live S3 buckets. After migration completes, it verifies correctness through automated checks, sample rendering, manual spot-checks, and a full build test. Finally, it archives original MDX and image files to a backup branch for safety.

Output: All blog content migrated to S3, verified, and originals archived to git branch `backup/pre-s3-migration`
</objective>

<execution_context>
@C:/Users/abdie/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/abdie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-content-migration/21-CONTEXT.md
@.planning/phases/21-content-migration/21-01-SUMMARY.md
@scripts/migrate-blog-to-s3.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute live migration and run automated verification</name>
  <files></files>
  <action>
**Pre-flight checks:**
1. Verify S3_ARTICLES_BUCKET_NAME and S3_IMAGES_BUCKET_NAME env vars are set
2. Run `node scripts/migrate-blog-to-s3.js --dry-run` one final time to confirm no errors

**Execute migration:**
1. Run `node scripts/migrate-blog-to-s3.js --live`
2. Monitor for any errors — script should complete with all 77 posts and 215 images
3. Verify exit code is 0

**Automated verification (method 1 — count check):**
After migration completes, verify counts match:
- Read migration-log.json
- Confirm posts.total matches number of MDX/MD files found
- Confirm images.total matches number of unique images found

**Automated verification (method 2 — sample rendering):**
Run the dev server briefly to test rendering of spot-check posts:
- Start dev server: `npm run dev` (background)
- Wait for server to be ready
- Use curl or fetch to request 3-5 spot-check URLs from migration-log.json spotCheckList
- Verify each returns HTTP 200 (not 404 or 500)
- Stop dev server

**Automated verification (method 4 — full build test):**
- Run `npm run build`
- Verify it completes without errors
- Check that blog static pages are generated for migrated articles

Log all verification results clearly.
  </action>
  <verify>
1. migration-log.json shows mode: "live" with all posts/images migrated
2. Count check: posts and images totals match expected (77 posts, 215 images)
3. Sample rendering: spot-check URLs return HTTP 200
4. Build test: `npm run build` completes successfully
  </verify>
  <done>
Live migration completed with all posts and images uploaded to S3. Automated count check, sample rendering, and build test all pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Manual spot-check of migrated posts</name>
  <files></files>
  <action>
**What was built:** All 77 blog posts migrated to S3 with images. The migration script has identified specific posts for manual review.

**How to verify:**
1. Start the dev server: `npm run dev`
2. Open `migration-log.json` and find the `spotCheckList` array
3. For each entry in the spot-check list, visit the URL in the browser:
   - **Oldest post**: Verify text content renders, featured image loads from S3 URL
   - **Newest post**: Verify content and images load correctly
   - **Post with ResponsiveReactPlayer**: Verify embedded video player renders
   - **Post with multiple images**: Verify ALL images load from S3 URLs (not local paths)
   - **Draft post**: Verify it does NOT appear in the blog listing at /blog
4. On any post page, right-click an image and select "Copy image address" then confirm it starts with `https://{S3_IMAGES_BUCKET_NAME}.s3.amazonaws.com/`
5. Visit /blog to confirm article listing shows all published posts with correct titles, dates, and thumbnails
6. Visit /tags to confirm tag cloud shows correct tag counts

**Resume signal:** Type "approved" if all spot-checks pass, or describe any issues found
  </action>
  <verify>User confirms all spot-check posts render correctly with S3 images and correct content</verify>
  <done>Manual spot-check approved by user — migrated posts render correctly with S3 images, video embeds work, draft posts hidden, blog listing and tags accurate</done>
</task>

<task type="auto">
  <name>Task 3: Archive original files to backup git branch</name>
  <files></files>
  <action>
After user approves spot-check verification, archive original blog content to a backup branch:

1. Create backup branch: `git checkout -b backup/pre-s3-migration`
2. The branch already contains all original files (data/blog/ and public/static/images/blog/) since they exist on the current branch
3. Switch back to feature branch: `git checkout feature/article-manager`
4. Remove migrated files from the working branch:
   - `git rm -r data/blog/` (all MDX/MD files)
   - `git rm -r public/static/images/blog/` (all blog images)
   - Keep `public/static/images/telescope_color.png` ONLY if it's referenced by non-blog pages (check first — if only referenced by telescopios.mdx which is now in S3, remove it too)
5. Commit the removal with message: `chore(21): archive original blog content to backup/pre-s3-migration`
6. Verify the backup branch still has all files: `git log backup/pre-s3-migration --oneline -1`
7. Run `npm run build` one final time to confirm the site builds without the local files (all content from S3 now)

**Important:** Do NOT delete the backup branch. It serves as a rollback path.
  </action>
  <verify>
1. `git branch --list backup/pre-s3-migration` shows the branch exists
2. `git show backup/pre-s3-migration:data/blog/2017/04/13/PlanetaDosSoles04132017.mdx` returns the file content (backup preserved)
3. `data/blog/` directory no longer exists on feature/article-manager
4. `public/static/images/blog/` directory no longer exists on feature/article-manager
5. `npm run build` completes successfully (site renders from S3 only)
  </verify>
  <done>
Original blog MDX files and images archived to backup/pre-s3-migration branch. Feature branch cleaned up. Build confirms site works entirely from S3 content.
  </done>
</task>

</tasks>

<verification>
1. All 77 posts accessible via S3 article API (articles/{slug}.json exists for each)
2. All 215 images accessible via S3 image URLs (HTTP 200 on image URLs)
3. Blog index at /blog shows all published posts
4. Tag pages at /tags show correct counts
5. Build passes without local blog files
6. Backup branch preserves all original content
</verification>

<success_criteria>
- Live migration completed with 77 posts and 215 images in S3
- All four verification methods passed (count check, sample rendering, manual spot-check, build test)
- Original files archived to backup/pre-s3-migration branch
- Site builds and renders entirely from S3 content
- No data loss — backup branch preserves all original files
</success_criteria>

<output>
After completion, create `.planning/phases/21-content-migration/21-02-SUMMARY.md`
</output>
